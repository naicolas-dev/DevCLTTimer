<UserControl x:Class="DevCLT.WindowsApp.Views.TimerView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:controls="clr-namespace:DevCLT.WindowsApp.Controls"
             xmlns:conv="clr-namespace:DevCLT.WindowsApp.Converters">

    <UserControl.Resources>
        <conv:BoolToVisibilityConverter x:Key="BoolVis" />
        <conv:StateToVisibilityConverter x:Key="StateVis" />
        <conv:HotkeyToKbdConverter x:Key="HotkeyKbd" />
    </UserControl.Resources>

    <Grid>
        <!-- Main Content -->
        <Grid Margin="{StaticResource WindowPadding}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Badge -->
            <Border Grid.Row="0" HorizontalAlignment="Center" Margin="0,0,0,16"
                    Style="{StaticResource BadgeWorking}" x:Name="StateBadge">
                <TextBlock Text="{Binding StateLabel}"
                           Style="{StaticResource LabelText}"
                           Foreground="{DynamicResource TextPrimaryBrush}" />
            </Border>

            <!-- Timer Ring + Display -->
            <Grid Grid.Row="1" HorizontalAlignment="Center" VerticalAlignment="Center">
                <controls:TimerRing Progress="{Binding Progress}" IsWarning="{Binding IsWarning}" />
                <Viewbox MaxWidth="220" Stretch="Uniform">
                    <TextBlock Text="{Binding DisplayTime}"
                               Style="{StaticResource TimerDisplayText}"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center" />
                </Viewbox>
            </Grid>

            <!-- Action Buttons -->
            <StackPanel Grid.Row="2" HorizontalAlignment="Center" Margin="0,16,0,0">
                <!-- Working state: "Iniciar pausa" + "Encerrar jornada" -->
                <StackPanel Visibility="{Binding CurrentState, Converter={StaticResource StateVis}, ConverterParameter=Working}">
                    <Button Style="{StaticResource PrimaryButton}"
                            Command="{Binding ShowStartBreakConfirmCommand}"
                            HorizontalAlignment="Stretch"
                            Margin="0,0,0,8">
                        <Button.Content>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                <TextBlock Text="Iniciar pausa" VerticalAlignment="Center" />
                                <ContentControl Content="{Binding DataContext.SettingsVM.PausaKey, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource HotkeyKbd}}" VerticalAlignment="Center" />
                            </StackPanel>
                        </Button.Content>
                    </Button>
                    <Button Style="{StaticResource TertiaryButton}"
                            Command="{Binding ShowEndDayConfirmCommand}"
                            HorizontalAlignment="Center">
                        <Button.Content>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="Encerrar jornada" VerticalAlignment="Center" />
                                <ContentControl Content="{Binding DataContext.SettingsVM.JornadaKey, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource HotkeyKbd}}" VerticalAlignment="Center" />
                            </StackPanel>
                        </Button.Content>
                    </Button>
                </StackPanel>

                <StackPanel Visibility="{Binding CurrentState, Converter={StaticResource StateVis}, ConverterParameter=Break}">
                    <Button Style="{StaticResource SecondaryButton}"
                            Command="{Binding ShowEndBreakEarlyConfirmCommand}"
                            HorizontalAlignment="Center">
                        <Button.Content>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="Encerrar pausa" VerticalAlignment="Center" />
                                <ContentControl Content="{Binding DataContext.SettingsVM.PausaKey, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource HotkeyKbd}}" VerticalAlignment="Center" />
                            </StackPanel>
                        </Button.Content>
                    </Button>
                </StackPanel>

                <!-- BreakEndedWaitingUser: handled by modal -->

                <StackPanel Visibility="{Binding CurrentState, Converter={StaticResource StateVis}, ConverterParameter=Overtime}">
                    <Button Style="{StaticResource DangerButton}"
                            Command="{Binding StopOvertimeCommand}">
                        <Button.Content>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="Encerrar hora extra" VerticalAlignment="Center" />
                                <ContentControl Content="{Binding DataContext.SettingsVM.OvertimeKey, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource HotkeyKbd}}" VerticalAlignment="Center" />
                            </StackPanel>
                        </Button.Content>
                    </Button>
                </StackPanel>

                <!-- WorkCompleted: modal has overtime button -->
                <StackPanel Visibility="{Binding ShowWorkCompletedModal, Converter={StaticResource BoolVis}}">
                </StackPanel>
            </StackPanel>
        </Grid>

        <!-- â•â• Modal: Break Ended â•â• -->
        <Border Visibility="{Binding ShowBreakEndedModal, Converter={StaticResource BoolVis}}"
                Style="{StaticResource ModalOverlay}">
            <Border Style="{StaticResource ModalCard}">
                <StackPanel>
                    <TextBlock Text="Pausa concluÃ­da"
                               Style="{StaticResource HeaderText}"
                               Margin="0,0,0,8" />
                    <TextBlock Text="Clique para retomar o trabalho."
                               Style="{StaticResource BodyText}"
                               TextWrapping="Wrap"
                               Margin="0,0,0,24" />
                    <Button Style="{StaticResource PrimaryButton}"
                            Content="Retomar trabalho"
                            Command="{Binding ResumeWorkCommand}"
                            HorizontalAlignment="Stretch" />
                </StackPanel>
            </Border>
        </Border>

        <!-- â•â• Modal: Work Completed â•â• -->
        <Border Visibility="{Binding ShowWorkCompletedModal, Converter={StaticResource BoolVis}}"
                Style="{StaticResource ModalOverlay}">
            <Border Style="{StaticResource ModalCard}">
                <StackPanel>
                    <TextBlock Text="Jornada concluÃ­da! ðŸŽ‰"
                               Style="{StaticResource HeaderText}"
                               Margin="0,0,0,8" />
                    <TextBlock Text="VocÃª completou suas horas de trabalho. O que deseja fazer?"
                               Style="{StaticResource BodyText}"
                               TextWrapping="Wrap"
                               Margin="0,0,0,24" />
                    <Button Style="{StaticResource PrimaryButton}"
                            Content="Concluir"
                            Command="{Binding EndDayCommand}"
                            HorizontalAlignment="Stretch"
                            Margin="0,0,0,8" />
                    <Button Style="{StaticResource SecondaryButton}"
                            Content="Iniciar hora extra"
                            Command="{Binding StartOvertimeCommand}"
                            HorizontalAlignment="Stretch" />
                </StackPanel>
            </Border>
        </Border>

        <!-- â•â• Modal: End Day Confirm â•â• -->
        <Border Visibility="{Binding ShowEndDayConfirm, Converter={StaticResource BoolVis}}"
                Style="{StaticResource ModalOverlay}">
            <Border Style="{StaticResource ModalCard}">
                <StackPanel>
                    <TextBlock Text="Encerrar jornada?"
                               Style="{StaticResource HeaderText}"
                               Margin="0,0,0,8" />
                    <TextBlock Text="Sua jornada ainda nÃ£o terminou. Deseja encerrar agora?"
                               Style="{StaticResource BodyText}"
                               TextWrapping="Wrap"
                               Margin="0,0,0,24" />
                    <Button Style="{StaticResource DangerButton}"
                            Content="Sim, encerrar"
                            Command="{Binding ConfirmEndDayCommand}"
                            HorizontalAlignment="Stretch"
                            Margin="0,0,0,8" />
                    <Button Style="{StaticResource SecondaryButton}"
                            Content="Cancelar"
                            Command="{Binding CancelEndDayCommand}"
                            HorizontalAlignment="Stretch" />
                </StackPanel>
            </Border>
        </Border>
        <!-- â•â• Modal: Start Break Confirm â•â• -->
        <Border Visibility="{Binding ShowStartBreakConfirm, Converter={StaticResource BoolVis}}"
                Style="{StaticResource ModalOverlay}">
            <Border Style="{StaticResource ModalCard}">
                <StackPanel>
                    <TextBlock Text="Iniciar pausa?"
                               Style="{StaticResource HeaderText}"
                               Margin="0,0,0,8" />
                    <TextBlock Text="Deseja pausar o trabalho agora?"
                               Style="{StaticResource BodyText}"
                               TextWrapping="Wrap"
                               Margin="0,0,0,24" />
                    <Button Style="{StaticResource PrimaryButton}"
                            Content="Sim, iniciar pausa"
                            Command="{Binding ConfirmStartBreakCommand}"
                            HorizontalAlignment="Stretch"
                            Margin="0,0,0,8" />
                    <Button Style="{StaticResource SecondaryButton}"
                            Content="Cancelar"
                            Command="{Binding CancelStartBreakCommand}"
                            HorizontalAlignment="Stretch" />
                </StackPanel>
            </Border>
        </Border>
        <!-- â•â• Modal: End Break Early Confirm â•â• -->
        <Border Visibility="{Binding ShowEndBreakEarlyConfirm, Converter={StaticResource BoolVis}}"
                Style="{StaticResource ModalOverlay}">
            <Border Style="{StaticResource ModalCard}">
                <StackPanel>
                    <TextBlock Text="Encerrar pausa?"
                               Style="{StaticResource HeaderText}"
                               Margin="0,0,0,8" />
                    <TextBlock Text="Deseja retornar ao trabalho antes da pausa terminar?"
                               Style="{StaticResource BodyText}"
                               TextWrapping="Wrap"
                               Margin="0,0,0,24" />
                    <Button Style="{StaticResource PrimaryButton}"
                            Content="Sim, retornar ao trabalho"
                            Command="{Binding EndBreakEarlyCommand}"
                            HorizontalAlignment="Stretch"
                            Margin="0,0,0,8" />
                    <Button Style="{StaticResource SecondaryButton}"
                            Content="Cancelar"
                            Command="{Binding CancelEndBreakEarlyCommand}"
                            HorizontalAlignment="Stretch" />
                </StackPanel>
            </Border>
        </Border>
    </Grid>
</UserControl>
